<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Test TradingView Simple</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<div id="tvchart" style="width:720px;height:420px;margin:50px auto;border:1px solid #eee;"></div>
<script>
const chart = LightweightCharts.createChart(document.getElementById('tvchart'), {
  width:700, height:400, layout:{background:{color:'#fff'},textColor:'#223'}
});
const candleSeries = chart.addCandlestickSeries({ upColor:'#26a69a', downColor:'#e96d76', wickUpColor:'#26a69a', wickDownColor:'#e96d76', borderVisible: false });
let buffer = [];
fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100')
.then(r=>r.json())
.then(data=>{
  buffer = data.map(c => ({ time: Math.floor(c[0]/1000), open: +c[1], high: +c[2], low: +c[3], close: +c[4] }));
  candleSeries.setData(buffer);
});
const s = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@kline_1m');
s.onmessage = ev => {
  const {k} = JSON.parse(ev.data);
  if (!k) return;
  const c = { time: Math.floor(k.t/1000), open: +k.o, high: +k.h, low: +k.l, close: +k.c };
  if (buffer.length && c.time === buffer[buffer.length-1].time) buffer[buffer.length-1] = c;
  else buffer.push(c), buffer.length > 300 && buffer.shift();
  candleSeries.setData(buffer);
};
</script>
</body>
</html>
