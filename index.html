<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>SMC Trading Bot - BTC/USDT (Bitget Live)</title>
  <style>
    body { margin:0; background:#f5f7fa; font-family:sans-serif; }
    .dashboard-main {
      width:100vw; height:100vh; display:flex; background:#f5f7fa;
    }
    .left-panel {
      flex:1; display:flex; align-items:center; justify-content:center;
      background:#fff;
    }
    .central-panel {
      flex:2.2; background:#eef3fa; display:flex; flex-direction:column; justify-content:center; padding:50px 16px 20px 16px;
    }
    .chart-area {
      background:#fff;border-radius:10px;padding:28px 16px; box-shadow:0 2px 8px #eaeaea;
    }
    .price-box {
      font-size:2.5em;color:#33cc66;font-weight:700;text-align:center;letter-spacing:2px;margin-bottom:18px;transition:.2s;
    }
    .live-dot { display:inline-block; width:12px;height:12px;border-radius:50%; background:#3acc3a;animation:blink .8s infinite alternate;vertical-align:middle;margin-right:8px;}
    @keyframes blink{ to { opacity:.3; } }
    .right-panel {
      flex:1; background:#fff;display:flex;flex-direction:column;gap:18px;padding:32px 16px;box-shadow:-2px 0 10px #ececec;
      min-width:320px; max-width:400px; height:100vh;overflow-y:auto;
    }
    .panel {
      margin-bottom:14px;background:#f6f9fb;padding:18px 12px;border-radius:10px;box-shadow:0 2px 6px #e8e8e8;
    }
    .panel-title { color:#234; font-weight: bold; margin-bottom:9px;font-size:1.07em;text-transform:uppercase;}
    .kpi-row { display:flex; justify-content:space-between;margin-bottom:5px; }
    .kpi-label {color:#666;}
    .kpi-value {font-weight:700;}
    .kpi-value.green {color:#33cc66;}
    .kpi-value.red {color:#ff4444;}
    .kpi-value.neutral {color:#808080;}

    /* Responsive */
    @media (max-width:1000px){
      .dashboard-main{flex-direction:column;}
      .right-panel{width:100vw;max-width:unset;height:auto;box-shadow:none;}
      .central-panel{padding:16px;}
    }
  </style>
</head>
<body>
  <div class="dashboard-main">
    <div class="left-panel">
      <img src="https://img.icons8.com/external-flatarticons-blue-flatarticons/120/000000/external-bitcoin-fintech-flatarticons-blue-flatarticons.png" style="width:90px;opacity:.75;">
    </div>
    <div class="central-panel">
      <div class="chart-area">
        <div id="price" class="price-box">Chargement...</div>
        <canvas id="priceChart" height="180" style="width:100%;max-width:700px;margin:0 auto;display:block;"></canvas>
      </div>
    </div>
    <div class="right-panel">
      <div class="panel">
        <div class="panel-title">Analyse M15</div>
        <div class="kpi-row"><div class="kpi-label">Tendance</div><div id="trend-m15" class="kpi-value neutral">Neutre</div></div>
        <div class="kpi-row"><div class="kpi-label">Structure</div><div id="structure-m15" class="kpi-value">-</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">Détection Sweep M1</div>
        <div class="kpi-row"><div class="kpi-label">Statut</div><div id="sweep-status" class="kpi-value neutral">En attente</div></div>
        <div class="kpi-row"><div class="kpi-label">Type</div><div id="sweep-type" class="kpi-value">-</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">Signal Actuel</div>
        <div id="signal-status" style="color:#888;opacity:.85;">Aucun signal actif</div>
      </div>
      <div class="panel">
        <div class="panel-title">Paramètres de Trade</div>
        <div class="kpi-row"><div class="kpi-label">Entrée</div><div id="trade-entry" class="kpi-value">-</div></div>
        <div class="kpi-row"><div class="kpi-label">Stop Loss</div><div id="trade-sl" class="kpi-value">-</div></div>
        <div class="kpi-row"><div class="kpi-label">TP1</div><div id="trade-tp1" class="kpi-value">-</div></div>
        <div class="kpi-row"><div class="kpi-label">TP2</div><div id="trade-tp2" class="kpi-value">-</div></div>
      </div>
    </div>
  </div>
  <script>
    // --- Mini Chart sans dépendance externe ---
    const priceChart = document.getElementById('priceChart');
    const pctx = priceChart.getContext('2d');
    let priceBuffer = [], maxPrices = 40;

    function drawChart(arr) {
      pctx.clearRect(0,0,priceChart.width,priceChart.height);
      if (arr.length<3) return;
      let min = Math.min(...arr), max = Math.max(...arr);
      let w = priceChart.width, h = priceChart.height;
      let stepX = w/(arr.length-1);
      pctx.beginPath();
      pctx.moveTo(0, h - (arr[0]-min)/(max-min)*h);
      for (let i=1;i<arr.length;i++)
        pctx.lineTo(i*stepX, h - (arr[i]-min)/(max-min)*h);
      pctx.strokeStyle="#33cc66"; pctx.lineWidth=4;
      pctx.stroke();
      // Fill under
      pctx.lineTo(w,h); pctx.lineTo(0,h); pctx.closePath();
      pctx.globalAlpha=0.08;pctx.fillStyle="#33cc66";pctx.fill();
      pctx.globalAlpha=1;
    }

    // --- Logique SMC simplifiée JS ---
    let candlesM1 =[], candlesM15=[];
    function addCandle(buffer, c){ buffer.push(c); if(buffer.length > 100) buffer.shift(); }
    function getStructureM15(candles){
      let s=[];for(let i=1;i<candles.length;i++){
        let prev=candles[i-1], curr=candles[i];
        if (curr.high > prev.high && curr.low > prev.low) s.push('HH');
        else if (curr.low > prev.low && curr.high < prev.high) s.push('HL');
        else if (curr.high < prev.high && curr.low < prev.low) s.push('LL');
        else if (curr.high < prev.high && curr.low > prev.low) s.push('LH');
        else s.push('N');
      }
      return s;
    }
    function detectTrendM15(candles){
      let s = getStructureM15(candles);
      if (s.length<3) return 'neutre';
      let l=s.length-1, prev1=s[l-1], prev2=s[l-2];
      if (prev2==='HL'&&prev1==='HH'&&s[l]==='HH') return 'bullish';
      if (prev2==='LH'&&prev1==='LL'&&s[l]==='LL') return 'bearish';
      if (s[l]==='HL'&&prev1==='LH') return 'bullish';
      if (s[l]==='LH'&&prev1==='HL') return 'bearish';
      return 'neutre';
    }
    function detectSweep(candles,lookback=5){
      if (candles.length<lookback+1) return [null,null];
      let lc=candles[candles.length-1],
      highs=candles.slice(-lookback-1,-1).map(c=>c.high),
      lows=candles.slice(-lookback-1,-1).map(c=>c.low);
      if (lc.high>Math.max(...highs)) return ['buy-side',lc.high];
      if (lc.low<Math.min(...lows)) return ['sell-side',lc.low];
      return [null,null];
    }
    function detectLiquidityPool(candles, dir, lookback=20){
      let highs=candles.slice(-lookback-1,-1).map(c=>c.high),
        lows=candles.slice(-lookback-1,-1).map(c=>c.low);
      return dir==='short' ? Math.min(...lows) : Math.max(...highs);
    }
    function calcTradeParams(dir, sweep, obp, pool, riskPct=0.5, rr=1){
      let slbuf=sweep*(riskPct/100), sl, tp1;
      if (dir==='short'){ sl=sweep+slbuf; tp1=obp-(sl-obp)*rr;}
      else { sl=sweep-slbuf; tp1=obp+(obp-sl)*rr; }
      return {
        entry:obp.toFixed(2), sl:sl.toFixed(2), tp1:tp1.toFixed(2), tp2:pool.toFixed(2)
      };
    }

    // --- DOM bindings ---
    const priceEl=document.getElementById('price');
    const trendEl=document.getElementById('trend-m15'), structEl=document.getElementById('structure-m15');
    const sweepStatEl = document.getElementById('sweep-status'), sweepTypeEl = document.getElementById('sweep-type');
    const signalStatEl=document.getElementById('signal-status');
    const tEntry=document.getElementById('trade-entry'), tSL=document.getElementById('trade-sl'),
      tTP1=document.getElementById('trade-tp1'), tTP2=document.getElementById('trade-tp2');

    // --- WebSocket Bitget ---
    const ws=new WebSocket('wss://ws.bitget.com/mix/v1/stream');
    ws.onopen=()=>{ priceEl.innerHTML = '<span class="live-dot"></span> Chargement...';
      ws.send(JSON.stringify({ op:"subscribe", args:[
        {instType:"mc", channel:"ticker", instId:"BTCUSDT_UMCBL"},
        {instType:"mc", channel:"candle1m", instId:"BTCUSDT_UMCBL"},
        {instType:"mc", channel:"candle15m", instId:"BTCUSDT_UMCBL"}
      ] }));
      sweepStatEl.textContent="En attente"; sweepTypeEl.textContent="-";
    }
    ws.onmessage=ev=>{
      let d; try{ d=JSON.parse(ev.data); }catch{ return;}
      if(d.arg&&d.data&&d.data.length){
        const ch=d.arg.channel;
        // --- Prix live ticker ---
        if(ch==="ticker"){
          let last = parseFloat(d.data[0].last);
          priceBuffer.push(last); if(priceBuffer.length>maxPrices) priceBuffer.shift();
          priceEl.innerHTML = `<span class="live-dot"></span> ${last.toFixed(2)} $`;
          drawChart(priceBuffer);
        }
        // --- Candle 1m pour sweep, param --
        if(ch==="candle1m"){
          let c=d.data[0], x={
            timestamp: c[0],open: +c[1],high:+c[2],low:+c[3],close:+c[4],volume:+c[5]
          }; addCandle(candlesM1,x);
          let [sweepType, sweepPrice]=detectSweep(candlesM1);        
          if(sweepType){
            sweepStatEl.innerHTML='<span class="live-dot"></span> Nouveau sweep';
            sweepTypeEl.textContent=sweepType;
          } else {
            sweepStatEl.textContent="En attente";
            sweepTypeEl.textContent='-';
          }
        }
        // --- Candle 15m pour structure/tendance --
        if(ch==="candle15m"){
          let c=d.data[0], x={
            timestamp: c[0],open: +c[1],high:+c[2],low:+c[3],close:+c[4],volume:+c[5]
          }; addCandle(candlesM15,x);
          let struct=getStructureM15(candlesM15);
          structEl.textContent=struct.length?struct.slice(-1)[0]:'-';
          let trend=detectTrendM15(candlesM15);
          trendEl.textContent=trend.charAt(0).toUpperCase()+trend.slice(1);
          trendEl.className='kpi-value '+(trend==='bullish'?'green':(trend==='bearish'?'red':'neutral'));
          // Check SMC signal
          let [sweepType, sweepPrice]=detectSweep(candlesM1);
          let direction=null;
          if (trend==='bullish'&&sweepType==='sell-side') direction='long';
          if (trend==='bearish'&&sweepType==='buy-side') direction='short';
          if (!direction){ signalStatEl.textContent="Aucun signal actif"; tEntry.textContent=tSL.textContent=tTP1.textContent=tTP2.textContent="-"; }
          else {
            let obPrice=candlesM1.length?candlesM1[candlesM1.length-1].close:NaN;
            let poolPrice=detectLiquidityPool(candlesM1,direction);
            let levels=calcTradeParams(direction,sweepPrice,obPrice,poolPrice);
            signalStatEl.innerHTML='<span class="live-dot"></span> Signal '+direction.toUpperCase();
            tEntry.textContent=levels.entry; tSL.textContent=levels.sl;
            tTP1.textContent=levels.tp1; tTP2.textContent=levels.tp2;
          }
        }
      }
    }
    ws.onerror=()=>{priceEl.textContent="Erreur flux live";};
    ws.onclose=()=>{priceEl.textContent="Déconnecté";};

  </script>
</body>
</html>
